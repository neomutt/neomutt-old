From 9f5565e0188c1ca489186803b30790017df79f78 Mon Sep 17 00:00:00 2001
From: Richard Russon <rich@flatcap.org>
Date: Fri, 6 May 2016 19:53:13 +0100
Subject: [PATCH 02/22] patches-20160502/sensible-browser

---
 PATCHES                 |  1 +
 README.sensible-browser | 39 +++++++++++++++++++++
 browser.c               | 30 ++++++++++++-----
 doc/manual.xml.head     | 90 +++++++++++++++++++++++++++++++++++++++++++++++++
 menu.c                  | 11 ++++++
 mutt_menu.h             |  1 +
 6 files changed, 164 insertions(+), 8 deletions(-)
 create mode 100644 README.sensible-browser

Index: neomutt-20160818/PATCHES
===================================================================
--- neomutt-20160818.orig/PATCHES
+++ neomutt-20160818/PATCHES
@@ -1,3 +1,4 @@
+patch-sensible-browser-neo
 patch-compress-neomutt
 patch-cond-date-neomutt
 patch-fmemopen-neomutt
Index: neomutt-20160818/README.sensible-browser
===================================================================
--- /dev/null
+++ neomutt-20160818/README.sensible-browser
@@ -0,0 +1,39 @@
+Sensible-Browser Patch
+======================
+
+    Make the file browser behave
+
+Patch
+-----
+
+    To check if Mutt supports "sensible-browser", look for
+    "patch-sensible-browser" in the mutt version.
+
+    Dependencies
+    * mutt-1.5.24
+
+Introduction
+------------
+
+    When using the file/folder browser, the selection isn't always where you
+    would expect. When you navigate to '..' (parent folder), the selection
+    should show the folder you *used* to be in.
+
+See Also
+--------
+
+    * NeoMutt project
+
+Known Bugs
+----------
+
+    * Limited to IMAP folders
+    * Always on
+    * Should only select folder when folder is sorted alphabetically
+
+Credits
+-------
+
+    * Haakon Riiser <haakon.riiser@fys.uio.no>
+    * Richard Russon <rich@flatcap.org>
+
Index: neomutt-20160818/browser.c
===================================================================
--- neomutt-20160818.orig/browser.c
+++ neomutt-20160818/browser.c
@@ -76,6 +76,7 @@ typedef struct Folder
   int num;
 } struct Folder;
 
+static char OldLastDir[_POSIX_PATH_MAX] = "";
 static char LastDir[_POSIX_PATH_MAX] = "";
 static char LastDirBackup[_POSIX_PATH_MAX] = "";
 
@@ -893,17 +894,32 @@ static void init_menu (struct browser_st
   }
   else
 #endif
-  if (buffy)
+  if (buffy) {
+    menu->is_mailbox_list = 1;
     snprintf (title, titlelen, _("Mailboxes [%d]"), mutt_buffy_check (0));
-  else
+  } else
   {
+    menu->is_mailbox_list = 0;
     strfcpy (path, LastDir, sizeof (path));
     mutt_pretty_mailbox (path, sizeof (path));
 #ifdef USE_IMAP
-  if (state->imap_browse && option (OPTIMAPLSUB))
-    snprintf (title, titlelen, _("Subscribed [%s], File mask: %s"),
-	      path, NONULL (Mask.pattern));
-  else
+  if (state->imap_browse && option (OPTIMAPLSUB)) {
+    char *p = strrchr (OldLastDir, '/');
+    if (p && ((p - OldLastDir) == mutt_strlen (LastDir)) &&
+       (mutt_strncmp (LastDir, OldLastDir, p - OldLastDir) == 0)) {
+      /* If we get here, it means that LastDir is the parent directory of
+       * OldLastDir.  I.e., we're returning from a subdirectory, and we want
+       * to position the cursor on the directory we're returning from. */
+      int i;
+      for (i = 0; i < state->entrymax; i++) {
+        if (mutt_strcmp (state->entry[i].name, p + 1) == 0) {
+          menu->current = i;
+        }
+      }
+    }
+    snprintf (title, titlelen, _("Directory [%s], File mask: %s"),
+             path, NONULL(Mask.pattern));
+  } else
 #endif
     snprintf (title, titlelen, _("Directory [%s], File mask: %s"),
 	      path, NONULL(Mask.pattern));
@@ -1136,8 +1152,6 @@ void _mutt_select_file (char *f, size_t
 #endif
 	    )
 	  {
-	    char OldLastDir[_POSIX_PATH_MAX];
-
 	    /* save the old directory */
 	    strfcpy (OldLastDir, LastDir, sizeof (OldLastDir));
 
Index: neomutt-20160818/doc/manual.xml.head
===================================================================
--- neomutt-20160818.orig/doc/manual.xml.head
+++ neomutt-20160818/doc/manual.xml.head
@@ -13470,6 +13470,96 @@ openssl s_client -host &lt;imap server&g
   </sect2>
 </sect1>
 
+<sect1 id="sensible-browser">
+	<title>Sensible-Browser Patch</title>
+	<subtitle>Make the file browser behave</subtitle>
+
+	<sect2 id="sensible-browser-patch">
+		<title>Patch</title>
+
+		<para>
+			To check if Mutt supports <quote>sensible-browser</quote>, look for
+			<quote>patch-sensible-browser</quote> in the mutt version.
+			See: <xref linkend="mutt-patches"/>.
+		</para>
+
+		<itemizedlist>
+			<title>Dependencies:</title>
+			<listitem><para>mutt-1.5.24</para></listitem>
+		</itemizedlist>
+
+		<para>This patch is part of the <ulink url="https://github.com/neomutt/neomutt/wiki">NeoMutt Project</ulink>.</para>
+	</sect2>
+
+	<sect2 id="sensible-browser-intro">
+		<title>Introduction</title>
+
+		<para>
+			When using the file/folder browser, the selection isn't always where you would
+			expect. When you navigate to '..' (parent folder), the selection should show the
+			folder you <emphasis>used</emphasis> to be in.
+		</para>
+
+	</sect2>
+
+<!--
+	<sect2 id="sensible-browser-variables">
+		<title>Variables</title>
+		<para>None</para>
+	</sect2>
+
+	<sect2 id="sensible-browser-functions">
+		<title>Functions</title>
+		<para>None</para>
+	</sect2>
+
+	<sect2 id="sensible-browser-commands">
+		<title>Commands</title>
+		<para>None</para>
+	</sect2>
+
+	<sect2 id="sensible-browser-colors">
+		<title>Colors</title>
+		<para>None</para>
+	</sect2>
+
+	<sect2 id="sensible-browser-sort">
+		<title>Sort</title>
+		<para>None</para>
+	</sect2>
+-->
+
+	<sect2 id="sensible-browser-muttrc">
+		<title>Muttrc</title>
+		<para>None</para>
+	</sect2>
+
+	<sect2 id="sensible-browser-see-also">
+		<title>See Also</title>
+
+		<itemizedlist>
+			<listitem><para><ulink url="https://github.com/neomutt/neomutt/wiki">NeoMutt Project</ulink></para></listitem>
+		</itemizedlist>
+	</sect2>
+
+	<sect2 id="sensible-browser-known-bugs">
+		<title>Known Bugs</title>
+		<itemizedlist>
+			<listitem><para>Limited to IMAP folders</para></listitem>
+			<listitem><para>Always on</para></listitem>
+			<listitem><para>Should only select folder when folder is sorted alphabetically</para></listitem>
+		</itemizedlist>
+	</sect2>
+
+	<sect2 id="sensible-browser-credits">
+		<title>Credits</title>
+		<itemizedlist>
+		<listitem><para>Haakon Riiser <email>haakon.riiser@fys.uio.no</email></para></listitem>
+		<listitem><para>Richard Russon <email>rich@flatcap.org</email></para></listitem>
+		</itemizedlist>
+	</sect2>
+</sect1>
+
 </chapter>
 
 <chapter id="security">
Index: neomutt-20160818/menu.c
===================================================================
--- neomutt-20160818.orig/menu.c
+++ neomutt-20160818/menu.c
@@ -938,8 +938,17 @@ int menu_redraw (struct Menu *menu)
 
 int mutt_menuLoop (struct Menu *menu)
 {
+  static int last_position = -1;
   int i = OP_NULL;
 
+  if (menu->max && menu->is_mailbox_list) {
+    if (last_position > (menu->max - 1)) {
+      last_position = -1;
+    } else if (last_position >= 0) {
+      menu->current = last_position;
+    }
+  }
+
   FOREVER
   {
     if (option (OPTMENUCALLER))
@@ -1163,6 +1172,8 @@ int mutt_menuLoop (struct Menu *menu)
 	break;
 
       default:
+        if (menu->is_mailbox_list)
+          last_position = menu->current;
 	return (i);
     }
   }
Index: neomutt-20160818/mutt_menu.h
===================================================================
--- neomutt-20160818.orig/mutt_menu.h
+++ neomutt-20160818/mutt_menu.h
@@ -53,6 +53,7 @@ typedef struct Menu
   int offset;  /* row offset within the window to start the index */
   int pagelen;	/* number of entries per screen */
   int tagprefix;
+  int is_mailbox_list;
   struct MuttWindow *indexwin;
   struct MuttWindow *statuswin;
   struct MuttWindow *helpwin;
